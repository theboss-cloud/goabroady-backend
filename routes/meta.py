from flask import Blueprint, jsonify
from extensions import db
try:
    from models.program import Program
except ImportError:
    Program = None

meta_bp = Blueprint("meta", __name__, url_prefix="/api")

# ==========================================
# 🇨🇳 中国教育部普通高等学校本科专业目录 (精选版)
# 来源: 教育部高等教育司 2024/2025版本
# ==========================================
OFFICIAL_MAJORS = [
    # --- 哲学 ---
    "哲学", "逻辑学", "宗教学", "伦理学",
    
    # --- 经济学 ---
    "经济学", "经济统计学", "国民经济管理", "资源与环境经济学", "商务经济学", "能源经济", 
    "财政学", "税收学", "国际税收",
    "金融学", "金融工程", "保险学", "投资学", "金融数学", "信用管理", "经济与金融", "精算学", "互联网金融", "金融科技",
    "国际经济与贸易", "贸易经济", "国际经济发展合作",
    
    # --- 法学 ---
    "法学", "知识产权", "监狱学", "信用风险管理与法律防控", "国际经贸规则", "司法警察学",
    "政治学与行政学", "国际政治", "外交学", "国际事务与国际关系",
    "社会学", "社会工作", "人类学", "女性学", "家政学",
    "民族学", "马克思主义理论", "公安管理学",
    
    # --- 教育学 ---
    "教育学", "科学教育", "人文教育", "教育技术学", "艺术教育", "学前教育", "小学教育", "特殊教育", "华文教育",
    "体育教育", "运动训练", "社会体育指导与管理", "武术与民族传统体育", "运动人体科学", "运动康复", "休闲体育", "体能训练",
    
    # --- 文学 ---
    "汉语言文学", "汉语言", "汉语国际教育", "中国少数民族语言文学", "古典文献学", "应用语言学", "秘书学",
    "英语", "俄语", "德语", "法语", "西班牙语", "阿拉伯语", "日语", "波斯语", "朝鲜语", "菲律宾语", "梵语巴利语", "印尼语", "印地语", "柬埔寨语", "老挝语", "缅甸语", "马来语", "蒙古语", "僧伽罗语", "泰语", "乌尔都语", "希伯来语", "越南语", "葡萄牙语", "瑞典语", "塞尔维亚语", "土耳其语", "意大利语", "翻译", "商务英语",
    "新闻学", "广播电视学", "广告学", "传播学", "编辑出版学", "网络与新媒体", "数字出版", "时尚传播", "国际新闻与传播",
    
    # --- 历史学 ---
    "历史学", "世界史", "考古学", "文物与博物馆学", "文物保护技术", "外国语言与外国历史", "文化遗产",
    
    # --- 理学 ---
    "数学与应用数学", "信息与计算科学", "数理基础科学", "数据计算及应用",
    "物理学", "应用物理学", "核物理", "声学", "量子信息科学",
    "化学", "应用化学", "化学生物学", "分子科学与工程", "能源化学",
    "天文学", 
    "地理科学", "自然地理与资源环境", "人文地理与城乡规划", "地理信息科学",
    "大气科学", "应用气象学",
    "海洋科学", "海洋技术", "海洋资源与环境", "军事海洋学",
    "地球物理学", "空间科学与技术",
    "地质学", "地球化学", "地球信息科学与技术", "古生物学",
    "生物科学", "生物技术", "生物信息学", "生态学", "神经科学",
    "心理学", "应用心理学",
    "统计学", "应用统计学", "数据科学与大数据技术",
    
    # --- 工学 (热门) ---
    "理论与应用力学", "工程力学",
    "机械工程", "机械设计制造及其自动化", "材料成型及控制工程", "机械电子工程", "工业设计", "过程装备与控制工程", "车辆工程", "汽车服务工程", "智能制造工程",
    "测控技术与仪器", "精密仪器",
    "材料科学与工程", "材料物理", "材料化学", "冶金工程", "金属材料工程", "无机非金属材料工程", "高分子材料与工程", "复合材料与工程", "新能源材料与器件",
    "能源与动力工程", "能源与环境系统工程", "新能源科学与工程", "储能科学与工程",
    "电气工程及其自动化", "智能电网信息工程", "光源与照明", "电气工程与智能控制",
    "电子信息工程", "电子科学与技术", "通信工程", "微电子科学与工程", "光电信息科学与工程", "信息工程", "广播电视工程", "水声工程", "电子封装技术", "集成电路设计与集成系统", "医学信息工程", "电磁场与无线技术", "电波传播与天线", "电子信息科学与技术", "电信工程及管理", "应用电子技术教育", "人工智能", "海洋信息工程",
    "自动化", "轨道交通信号与控制", "机器人工程", "邮政工程", "核电技术与控制工程", "智能装备与系统", "工业智能",
    "计算机科学与技术", "软件工程", "网络工程", "信息安全", "物联网工程", "数字媒体技术", "智能科学与技术", "空间信息与数字技术", "电子与计算机工程", "数据科学与大数据技术", "网络空间安全", "新媒体技术", "电影制作", "保密技术", "服务科学与工程", "虚拟现实技术", "区块链工程",
    "土木工程", "建筑环境与能源应用工程", "给排水科学与工程", "建筑电气与智能化", "城市地下空间工程", "道路桥梁与渡河工程",
    "水利水电工程", "水文与水资源工程", "港口航道与海岸工程",
    "测绘工程", "遥感科学与技术",
    "化学工程与工艺", "制药工程", "资源循环科学与工程", "能源化学工程",
    "地质工程", "勘查技术与工程", "资源勘查工程",
    "采矿工程", "石油工程", "矿物加工工程", "油气储运工程",
    "纺织工程", "服装设计与工程",
    "轻化工程", "包装工程", "印刷工程",
    "交通运输", "交通工程", "航海技术", "轮机工程", "飞行技术", "交通设备与控制工程", "救助与打捞工程", "船舶电子电气工程",
    "船舶与海洋工程", "海洋工程与技术", "海洋资源开发技术",
    "航空航天工程", "飞行器设计与工程", "飞行器制造工程", "飞行器动力工程", "飞行器环境与生命保障工程", "飞行器质量与可靠性", "飞行器适航技术",
    "兵器类", # (略)
    "核工程与核技术", "辐射防护与核安全", "工程物理", "核化工与核燃料工程",
    "农业工程", "农业机械化及其自动化", "农业电气化", "农业水利工程",
    "林业工程", "木材科学与工程", "林产化工",
    "环境科学与工程", "环境工程", "环境科学", "环境生态工程", "环保设备工程", "资源环境科学", "水质科学与技术",
    "生物医学工程", "假肢矫形工程", "临床工程技术", "康复工程",
    "食品科学与工程", "食品质量与安全", "粮食工程", "乳品工程", "酿酒工程", "葡萄与葡萄酒工程", "食品营养与检验教育", "烹饪与营养教育",
    "建筑学", "城乡规划", "风景园林", "历史建筑保护工程",
    "安全工程", "应急技术与管理", "职业卫生工程",
    "生物工程", "生物制药",
    "公安技术类", # (略)
    
    # --- 农学 ---
    "农学", "园艺", "植物保护", "植物科学与技术", "种子科学与工程", "设施农业科学与工程",
    "农业资源与环境", "水土保持与荒漠化防治",
    "动物科学", "蚕学", "蜂学",
    "动物医学", "动物药学", "动植物检疫",
    "林学", "园林", "森林保护",
    "水产养殖学", "海洋渔业科学与技术",
    "草业科学",
    
    # --- 医学 ---
    "基础医学", "生物医学", "生物医学科学",
    "临床医学", "麻醉学", "医学影像学", "眼视光医学", "精神医学", "放射医学",
    "口腔医学",
    "预防医学", "食品卫生与营养学", "妇幼保健医学", "卫生监督", "全球健康学",
    "中医学", "针灸推拿学", "藏医学", "蒙医学", "维医学", "壮医学", "哈医学",
    "中西医临床医学",
    "药学", "药物制剂", "临床药学", "药事管理", "药物分析", "药物化学", "海洋药学",
    "中药学", "中药资源与开发", "藏药学", "蒙药学", "中药制药", "中草药栽培与鉴定",
    "法医学",
    "医学检验技术", "医学实验技术", "医学影像技术", "眼视光学", "康复治疗学", "口腔医学技术", "卫生检验与检疫", "听力与言语康复学",
    "护理学", "助产学",
    
    # --- 管理学 ---
    "管理科学", "信息管理与信息系统", "工程管理", "房地产开发与管理", "工程造价", "保密管理",
    "工商管理", "市场营销", "会计学", "财务管理", "国际商务", "人力资源管理", "审计学", "资产评估", "物业管理", "文化产业管理", "劳动关系", "体育经济与管理", "财务会计教育", "市场营销教育", "零售业管理",
    "农林经济管理", "农村区域发展",
    "公共事业管理", "行政管理", "劳动与社会保障", "土地资源管理", "城市管理", "海关管理", "交通管理", "海事管理", "公共关系学", "健康服务与管理", "海警后勤管理", "医疗产品管理", "医疗保险", "养老服务管理",
    "图书馆学", "档案学", "信息资源管理",
    "物流管理", "物流工程", "采购管理", "供应链管理",
    "工业工程", "标准化工程", "质量管理工程",
    "电子商务", "电子商务及法律", "跨境电子商务",
    "旅游管理", "酒店管理", "会展经济与管理", "旅游管理与服务教育",
    
    # --- 艺术学 ---
    "艺术史论", "艺术管理", "非物质文化遗产保护",
    "音乐表演", "音乐学", "作曲与作曲技术理论", "舞蹈表演", "舞蹈学", "舞蹈编导", "舞蹈教育",
    "表演", "戏剧学", "电影学", "戏剧影视文学", "广播电视编导", "戏剧影视导演", "戏剧影视美术设计", "录音艺术", "播音与主持艺术", "动画", "影视摄影与制作",
    "美术学", "绘画", "雕塑", "摄影", "书法学", "中国画", "实验艺术", "跨媒体艺术", "文物保护与修复", "漫画", "纤维艺术",
    "艺术设计学", "视觉传达设计", "环境设计", "产品设计", "服装与服饰设计", "公共艺术", "工艺美术", "数字媒体艺术", "艺术与科技", "陶瓷艺术设计", "新媒体艺术", "包装设计"
]

# === 原有的静态配置 (保留用于 AssessmentWizard) ===
OPTIONS = {
    # 学籍状态 / 学历层级 / 年级
    "status": [
        {"value":"studying","label":"在校"},
        {"value":"graduated","label":"已毕业"},
    ],
    "degree_levels": [
        {"value":"junior_college","label":"专科"},
        {"value":"bachelor","label":"本科"},
        {"value":"master","label":"硕士"},
        {"value":"phd","label":"博士"},
    ],
    "years": [
        {"value":"year1","label":"大一/研一"},
        {"value":"year2","label":"大二/研二"},
        {"value":"year3","label":"大三"},
        {"value":"year4","label":"大四"},
    ],
    # ... (其他不需要修改的静态选项) ...
}

@meta_bp.route('/constants', methods=['GET'])
def get_constants():
    db_countries = []
    if Program:
        try:
            countries_query = db.session.query(Program.country).distinct().all()
            db_countries = [c[0] for c in countries_query if c[0]]
        except: pass
        
    default_countries = ["美国", "英国", "澳大利亚", "加拿大", "新加坡", "中国香港", "德国", "法国", "日本", "韩国"]
    target_countries = sorted(list(set(db_countries + default_countries)))
    
    return jsonify({
        "countries": target_countries,
        "majors": OFFICIAL_MAJORS,
        "english_tests": ["IELTS (雅思)", "TOEFL (托福)", "PTE", "Duolingo", "CET-6 (六级)", "暂无"]
    })

@meta_bp.get("/meta/options")
def meta_options():
    return jsonify({"status": []})